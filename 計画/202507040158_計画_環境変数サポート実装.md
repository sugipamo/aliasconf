# 計画: 環境変数サポート実装

## 作成日時
2025年7月4日 01:58

## 背景
AliasConfは現在、YAML/JSONファイルからの設定読み込みのみをサポートしているが、現代的なアプリケーション開発では環境変数による設定の上書きが必須機能となっている。特に以下のシナリオで重要：

- コンテナ環境（Docker/Kubernetes）での設定
- CI/CD環境での設定
- 本番環境でのセキュアな設定管理
- 12-Factor Appの原則に準拠した開発

## 目的
1. 環境変数から設定値を読み込む機能を実装
2. `.env`ファイルのネイティブサポートを追加
3. 環境変数とファイル設定のマージ戦略を定義
4. 開発者にとって直感的で使いやすいAPIを提供

## 実装計画

### Phase 1: 基本的な環境変数サポート（v0.1.2）

#### 1.1 環境変数読み込み機能
```python
# 使用例
config = ConfigManager.from_files("config.yaml")
config.load_env_vars(prefix="ALIASCONF_")

# または
config = ConfigManager.from_files(
    "config.yaml",
    env_prefix="ALIASCONF_"
)
```

#### 1.2 実装詳細
- `src/aliasconf/loaders/env_loader.py`の作成
- 環境変数名のパース（`ALIASCONF_DATABASE_HOST` → `database.host`）
- 型推論（環境変数は文字列なので、適切な型に変換）
- ConfigManagerへの統合

#### 1.3 テスト
- `tests/test_env_loader.py`の作成
- モックを使用した環境変数のテスト
- 型変換のテスト
- プレフィックスのテスト

### Phase 2: .envファイルサポート（v0.1.3）

#### 2.1 .envファイル読み込み
```python
# 使用例
config = ConfigManager.from_env_file(".env")

# または複数ソースから
config = ConfigManager.from_files(
    "config.yaml",
    env_files=[".env", ".env.local"],
    env_prefix="ALIASCONF_"
)
```

#### 2.2 実装詳細
- `python-dotenv`ライブラリの依存関係追加（オプショナル）
- カスタム.envパーサーの実装も検討
- 複数の.envファイルの優先順位管理

### Phase 3: マージ戦略（v0.1.4）

#### 3.1 マージ戦略の定義
```python
# 使用例
config = ConfigManager.from_files(
    "config.yaml",
    env_prefix="ALIASCONF_",
    merge_strategy="override"  # or "merge", "deep_merge"
)
```

#### 3.2 戦略オプション
- **override**: 環境変数が既存の値を完全に上書き
- **merge**: 辞書型の値はマージ、その他は上書き
- **deep_merge**: ネストした辞書も再帰的にマージ

### Phase 4: エイリアス対応（v0.1.5）

#### 4.1 エイリアスへの環境変数マッピング
```python
# config.yaml
database:
  aliases: ["db", "storage"]
  host: "localhost"

# 環境変数
ALIASCONF_DB_HOST=production.db.com

# どちらのエイリアスでもアクセス可能
config.get("database.host")  # => "production.db.com"
config.get("db.host")        # => "production.db.com"
```

## 実装優先順位

1. **最優先**: 基本的な環境変数読み込み（Phase 1）
2. **高優先**: .envファイルサポート（Phase 2）
3. **中優先**: マージ戦略（Phase 3）
4. **低優先**: エイリアス対応（Phase 4）

## 技術的考慮事項

### セキュリティ
- 機密情報のログ出力防止
- 環境変数の検証
- インジェクション対策

### パフォーマンス
- 環境変数の読み込みキャッシュ
- 大量の環境変数に対する効率的な処理

### 互換性
- 既存APIとの後方互換性維持
- オプショナルな機能として実装

## 成功基準
1. 環境変数から設定値を読み込める
2. .envファイルをサポートする
3. 既存の機能を壊さない
4. パフォーマンスの劣化がない
5. ドキュメントとテストが完備されている

## タイムライン
- Phase 1: 1週間（基本実装とテスト）
- Phase 2: 1週間（.envサポート）
- Phase 3: 3日（マージ戦略）
- Phase 4: 3日（エイリアス対応）

合計: 約3週間

## 次のステップ
1. `env_loader.py`の基本実装開始
2. テストケースの作成
3. ConfigManagerへの統合
4. ドキュメントの更新